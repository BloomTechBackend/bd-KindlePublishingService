version: 2016-11-18
stack:
  name: ATACurriculumKindlePublishingServiceStack
  ec2MetadataURI: configuration/rde_ec2_metadata.yaml
  # Please see the following guide on how to configure credentials: https://w.amazon.com/index.php/RDE/How_do_I#Use_AWS_credentials_on_my_Mac
  # You can use RDE placeholders https://w.amazon.com/index.php/RDE/Features/Placeholders to customize account setings
  # and the rest of the definition file.

  devAccount:
    type: Conduit
    roleArn: arn:aws:iam::103877292781:role/IibsAdminAccess-DO-NOT-DELETE

  applications:
    ATACurriculumKindlePublishingService:
      type: container
      codeURI: ../../
      versionSet: ATACurriculumKindlePublishingService/development
      packages:
        ATACurriculumKindlePublishingService:
          buildTarget: release
          isApplicationTarget: true
        ATACurriculumKindlePublishingServiceImageBuild:
          buildTarget: release
          isBatsParameter: true
      environment:
        variables:
          AWS_CONTAINER_CREDENTIALS_RELATIVE_URI: "/role/IibsAdminAccess-DO-NOT-DELETE"
          ECS_CONTAINER_METADATA_URI: "http://169.254.170.2/v3"
      mountPoints:
      - sourceURI: mounts/apollo-shim-static-replacements
        destinationURI: /opt/apollo-shim-static-replacements
      networkMappings:
      - name: kindlepublishingservice.ata.amazon.com
        internalPort: 8080
        externalPort: 8080
        # The exposed port must not overlap between RDE applications https://w.amazon.com/bin/view/RDE/Definition/#networkMappings_2
        # exposed port format is 118[UNIT_NUMBER]
        # same as the non-debug version since we stop the current stack before each workflow
        exposedPort: 1184
        protocol: http
      - name: debug
        internalPort: 8054
        exposedPort: 5054 #Portforward and connect to this one from IDE
        protocol: tcp
    KindleHydraTestApp:
      type: hydra
      versionSet: ATACurriculumKindlePublishingService/development
      runDefinitionURI: mounts/hydra/runDefinition.json
      packages:
        ATACurriculumKindlePublishingServiceTCTs:
          majorVersion: C2020July
          isApplicationTarget: true

steps:
  stop:
    type: custom
    arguments:
      command: rde stack stop; rm -rf build/
  build-hydra:
    type: build
    arguments:
      applications:
        - KindleHydraTestApp
  build-ecs:
    type: build
    arguments:
      applications:
        - ATACurriculumKindlePublishingService
  deploy-ecs:
    type: deploy
    arguments:
      applications:
        - ATACurriculumKindlePublishingService
  container-build:
    type: build
    arguments:
      container: true
  deploy-hydra:
    type: deploy
    arguments:
      applications:
        - KindleHydraTestApp
  run-all-tests:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-all-preparedness-tests:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.preparedness.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-two:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.preparedness.two.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-three:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.preparedness.three.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-preparedness-test-four:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.preparedness.four.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-one-design:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.one.design.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-one:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.one.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-two:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.two.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-three:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.three.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-four-publish:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.four.publish.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-four:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.four.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.five.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-five-design:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.five.design.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-six-metrics:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.six.metrics.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-six-dashboard:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.six.dashboard.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-six:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.six.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  run-mastery-test-seven:
    type: stackExec
    arguments:
      applications:
        - KindleHydraTestApp
      scriptArguments: -p com.amazon.ata.kindlepublishingservice.test.mastery.seven.*
      scriptURI: "configuration/stack-exec/run-hydra-tests.sh"
  pipe-debug-port-socat:
    type: custom
    arguments:
      command: docker exec --detach ATACurriculumKindlePublishingService socat TCP-LISTEN:8054,fork TCP:127.0.0.1:5054;
workflows:
  default:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
  all-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-all-tests
  debug-all-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-all-tests
  preparedness-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-all-preparedness-tests
  debug-preparedness-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-all-preparedness-tests
  mastery-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one
    - run-mastery-test-two
    - run-mastery-test-three
    - run-mastery-test-four
    - run-mastery-test-five
    - run-mastery-test-six
    - run-mastery-test-seven
  debug-mastery-tasks:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one
    - run-mastery-test-two
    - run-mastery-test-three
    - run-mastery-test-four
    - run-mastery-test-five
    - run-mastery-test-six
    - run-mastery-test-seven
  preparedness-task2:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-two
  debug-preparedness-task2:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-two
  preparedness-task3:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-three
  debug-preparedness-task3:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-three
  preparedness-task4:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-four
  debug-preparedness-task4:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-preparedness-test-four
  tct-task1-design:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one-design
  debug-tct-task1-design:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one-design
  tct-task1:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one
  debug-tct-task1:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-one
  tct-task2:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-two
  debug-tct-task2:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-two
  tct-task3:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-three
  debug-tct-task3:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-three
  tct-task4-publish:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-four-publish
  debug-tct-task4-publish:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-four-publish
  tct-task4:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-four
  debug-tct-task4:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-four
  tct-task5-design:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-five-design
  debug-tct-task5-design:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-five-design
  tct-task5:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-five
  debug-tct-task5:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-five
  tct-task6-metrics:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-six-metrics
  tct-task6-dashboard:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-six-dashboard
  tct-task6:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-six
  debug-tct-task6:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-six
  tct-task7:
    - stop
    - build-ecs
    - deploy-ecs
    - build-hydra
    - deploy-hydra
    - run-mastery-test-seven
  debug-tct-task7:
    - stop
    - build-ecs
    - deploy-ecs
    - pipe-debug-port-socat
    - build-hydra
    - deploy-hydra
    - run-mastery-test-seven
